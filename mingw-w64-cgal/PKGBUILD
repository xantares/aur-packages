
pkgname=mingw-w64-cgal
pkgver=4.4
pkgrel=1
arch=(any)
pkgdesc="Computational Geometry Algorithms Library (mingw-w64)"
depends=('mingw-w64-crt' 'mingw-w64-mpfr' 'mingw-w64-boost' 'mingw-w64-zlib' 'mingw-w64-qt4')
makedepends=('mingw-w64-cmake')
options=('!buildflags' '!strip' 'staticlibs')
license=('GPL', 'LGPL')
url="http://www.cgal.org"
source=("https://gforge.inria.fr/frs/download.php/33524/CGAL-${pkgver}.tar.bz2")
sha1sums=('98f610e83827070f86b1b4f4240c298bbf4fa858')

_architectures="i686-w64-mingw32 x86_64-w64-mingw32"

prepare()
{
  cd "$srcdir/CGAL-${pkgver}"
  sed -i "s|_MSC_VER|_WIN32|g" include/CGAL/sse2.h
  sed -i "s|@CGAL_LIBRARY_INSTALLED@|CGAL|g" cmake/modules/CGALConfig_install.cmake.in
  sed -i "s|@CGAL_Core_LIBRARY_INSTALLED@|CGAL_Core|g" cmake/modules/CGALConfig_install.cmake.in
  sed -i "s|@CGAL_ImageIO_LIBRARY_INSTALLED@|CGAL_ImageIO|g" cmake/modules/CGALConfig_install.cmake.in
  sed -i "s|@CGAL_Qt4_LIBRARY_INSTALLED@|CGAL_Qt4|g" cmake/modules/CGALConfig_install.cmake.in
}

build()
{
  cd "$srcdir/CGAL-${pkgver}"
  for _arch in ${_architectures}; do
    unset LDFLAGS
    mkdir -p build-${_arch} && pushd build-${_arch}
    ${_arch}-cmake \
      -DCMAKE_BUILD_TYPE=Release \
      -DGCC_RUN_RES=0 -DGCC_RUN_RES__TRYRUN_OUTPUT="version=4.8.2" \
      -DGMP_RUN_RES=0 -DGMP_RUN_RES__TRYRUN_OUTPUT="version=5.1.3" \
      -DMPFR_RUN_RES=0 -DMPFR_RUN_RES__TRYRUN_OUTPUT="version=3.1.2" \
      -DZLIB_RUN_RES=0 -DZLIB_RUN_RES__TRYRUN_OUTPUT="version=1.2.8" \
      -DQT4_RUN_RES=0 -DQT4_RUN_RES__TRYRUN_OUTPUT="version=4.8.5" \
      -DOPENGL_RUN_RES=0 -DOPENGL_RUN_RES__TRYRUN_OUTPUT="version=3.0.4" \
      -DCGAL_CFG_BOOST_VARIANT_SWAP_BUG=0 -DCGAL_CFG_BOOST_VARIANT_SWAP_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_DENORMALS_COMPILE_BUG=0 -DCGAL_CFG_DENORMALS_COMPILE_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_FPU_ROUNDING_MODE_UNWINDING_VC_BUG=0 -DCGAL_CFG_FPU_ROUNDING_MODE_UNWINDING_VC_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_IEEE_754_BUG=0 -DCGAL_CFG_IEEE_754_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_ISTREAM_INT_BUG=0 -DCGAL_CFG_ISTREAM_INT_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_MATCHING_BUG_5=0 -DCGAL_CFG_MATCHING_BUG_5__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_MATCHING_BUG_6=0 -DCGAL_CFG_MATCHING_BUG_6__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_MATCHING_BUG_7=0 -DCGAL_CFG_MATCHING_BUG_7__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_MATCHING_BUG_8=0 -DCGAL_CFG_MATCHING_BUG_8__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_NESTED_CLASS_FRIEND_DECLARATION_BUG=0 -DCGAL_CFG_NESTED_CLASS_FRIEND_DECLARATION_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_NO_LIMITS=0 -DCGAL_CFG_NO_LIMITS__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_NO_NEXTAFTER=0 -DCGAL_CFG_NO_NEXTAFTER__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_NO_STL=0 -DCGAL_CFG_NO_STL__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_NO_WARNING_CPP_DIRECTIVE_BUG=0 -DCGAL_CFG_NO_WARNING_CPP_DIRECTIVE_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_NUMERIC_LIMITS_BUG=0 -DCGAL_CFG_NUMERIC_LIMITS_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_OUTOFLINE_MEMBER_DEFINITION_BUG=0 -DCGAL_CFG_OUTOFLINE_MEMBER_DEFINITION_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_TEMPLATE_IN_DEFAULT_PARAMETER_BUG=0 -DCGAL_CFG_TEMPLATE_IN_DEFAULT_PARAMETER_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_TYPENAME_BEFORE_DEFAULT_ARGUMENT_BUG=0 -DCGAL_CFG_TYPENAME_BEFORE_DEFAULT_ARGUMENT_BUG__TRYRUN_OUTPUT=" " \
      -DCGAL_CFG_USING_BASE_MEMBER_BUG_2=0 -DCGAL_CFG_USING_BASE_MEMBER_BUG_2__TRYRUN_OUTPUT=" " \
      ..
    make
    popd
  done
}

package()
{
  for _arch in ${_architectures}; do
    cd "$srcdir/CGAL-${pkgver}/build-${_arch}"
    make install DESTDIR="$pkgdir"
    rm -rf "$pkgdir"/usr/${_arch}/share
    ${_arch}-strip --strip-unneeded "$pkgdir"/usr/${_arch}/bin/*.dll
    ${_arch}-strip -g "$pkgdir"/usr/${_arch}/lib/*.a
  done
}
